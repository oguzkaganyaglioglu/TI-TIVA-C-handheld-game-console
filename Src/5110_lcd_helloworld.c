//
// Created by Oguz Kagan YAGLIOGLU on Oct 21, 2022.
// www.oguzkagan.xyz
//

/**
 * Hello World
 * This code prints hello world message to the screen
 * 
 * PINS:
 *      MOSI -> D3
 *      CLK  -> D0
 *      DC   -> E1
 *      CE   -> E2
 *      RST  -> E3
 * */

#include "string.h"
#include "tm4c123gh6pm.h"

void GPIOF_IntHandler() {}

void displaySendCommand(SPI_Handle_t* spi, GPIO_Handle_t* dc, GPIO_Handle_t* ce, uint8_t* buffer, uint32_t len);
void displaySendData(SPI_Handle_t* spi, GPIO_Handle_t* dc, GPIO_Handle_t* ce, uint8_t* buffer, uint32_t len);

static const uint8_t GAME_SCREEN[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7c, 0x10, 0x10, 0x7c, 0x00, 0x7c, 0x54, 0x54, 0x44, 0x00, 0x7c, 0x40,
    0x40, 0x40, 0x00, 0x7c, 0x40, 0x40, 0x40, 0x00, 0x38, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x7c,
    0x20, 0x10, 0x20, 0x7c, 0x00, 0x38, 0x44, 0x44, 0x38, 0x00, 0x7c, 0x14, 0x34, 0x48, 0x00, 0x7c,
    0x40, 0x40, 0x40, 0x00, 0x7c, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0,
    0x20, 0x20, 0xc0, 0x00, 0xc0, 0x20, 0xa0, 0x80, 0x00, 0xe0, 0x00, 0x00, 0xe0, 0x00, 0x20, 0xa0,
    0x60, 0x20, 0x00, 0x00, 0x00, 0xe0, 0x80, 0x40, 0x20, 0x00, 0xc0, 0xa0, 0xa0, 0xc0, 0x00, 0xc0,
    0x20, 0xa0, 0x80, 0x00, 0xc0, 0xa0, 0xa0, 0xc0, 0x00, 0xe0, 0x40, 0x80, 0xe0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x1a, 0x22, 0xe1, 0x20, 0x19, 0x02, 0xf2, 0x29, 0x28, 0xf1, 0x02, 0x72,
    0x89, 0xa8, 0x63, 0x02, 0xfa, 0x82, 0x80, 0x80, 0x00, 0x8b, 0xf8, 0x89, 0x02, 0x70, 0x8b, 0x88,
    0x70, 0x03, 0x70, 0x89, 0xaa, 0x62, 0x01, 0xf8, 0x83, 0x80, 0x80, 0x03, 0x78, 0x83, 0x80, 0x78,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

GPIO_Handle_t SPI_MOSI;
GPIO_Handle_t SPI_CLK;

GPIO_Handle_t displayCE;
GPIO_Handle_t displayDC;
GPIO_Handle_t displayRST;

SPI_Handle_t mySPI;

int main(void)
{
    SPI_CLK.pGPIOx_BaseAddress = GPIOD_AHB;
    SPI_CLK.GPIO_PinConfig.PinNumber = GPIO_PIN_0;
    SPI_CLK.GPIO_PinConfig.PinCNF = GPIO_CNF_OUT_PP;
    SPI_CLK.GPIO_PinConfig.PinPuPdControl = GPIO_NO_PU_PD;
    SPI_CLK.GPIO_PinConfig.PinAltFuncMode = 2;

    SPI_MOSI.pGPIOx_BaseAddress = GPIOD_AHB;
    SPI_MOSI.GPIO_PinConfig.PinNumber = GPIO_PIN_3;
    SPI_MOSI.GPIO_PinConfig.PinCNF = GPIO_CNF_OUT_PP;
    SPI_MOSI.GPIO_PinConfig.PinPuPdControl = GPIO_NO_PU_PD;
    SPI_MOSI.GPIO_PinConfig.PinAltFuncMode = 2;

    displayCE.pGPIOx_BaseAddress = GPIOE_AHB;
    displayCE.GPIO_PinConfig.PinNumber = GPIO_PIN_2;
    displayCE.GPIO_PinConfig.PinCNF = GPIO_CNF_OUT_PP;
    displayCE.GPIO_PinConfig.PinPuPdControl = GPIO_NO_PU_PD;
    displayCE.GPIO_PinConfig.PinAltFuncMode = 0;

    displayDC.pGPIOx_BaseAddress = GPIOE_AHB;
    displayDC.GPIO_PinConfig.PinNumber = GPIO_PIN_1;
    displayDC.GPIO_PinConfig.PinCNF = GPIO_CNF_OUT_PP;
    displayDC.GPIO_PinConfig.PinPuPdControl = GPIO_NO_PU_PD;
    displayDC.GPIO_PinConfig.PinAltFuncMode = 0;

    displayRST.pGPIOx_BaseAddress = GPIOE_AHB;
    displayRST.GPIO_PinConfig.PinNumber = GPIO_PIN_3;
    displayRST.GPIO_PinConfig.PinCNF = GPIO_CNF_OUT_PP;
    displayRST.GPIO_PinConfig.PinPuPdControl = GPIO_NO_PU_PD;
    displayRST.GPIO_PinConfig.PinAltFuncMode = 0;

    mySPI.pSPI = SPI1;
    mySPI.SPI_Config.SPI_CPHA = SPI_CPHA_LOW;
    mySPI.SPI_Config.SPI_CPOL = SPI_CPOL_LOW;
    mySPI.SPI_Config.SPI_SclkSpeed = SPI_SCLK_SPEED_DIV_16;
    mySPI.SPI_Config.SPI_DeviceMode = SPI_DeviceMode_MASTER;
    mySPI.SPI_Config.SPI_DFF = SPI_DFF_8BITS;

    GPIO_Init(&SPI_MOSI);
    GPIO_Init(&SPI_CLK);

    GPIO_Init(&displayCE);
    GPIO_Init(&displayDC);
    GPIO_Init(&displayRST);

    SPI_Init(&mySPI);

    GPIO_WritePin_H(&displayCE, true);
    GPIO_WritePin_H(&displayDC, false);

    // reset the display
    GPIO_WritePin_H(&displayRST, false);
    GPIO_WritePin_H(&displayRST, true);


    const uint8_t cmd_buffer[] = {
    0b00100001, // function set PD = 0 and V = 0, select extended instruction set (H = 1 mode)
    0b10010000, // set VOP; VOP is set to a +16 ´ b [V]
    0b00100000, // function set PD = 0 and V = 0, select normal instruction set (H = 0 mode)
    0b00001100, // display control set normal mode (D = 1 and E = 0)
    0b10000000, // cursor x = 0
    0b01000000  // cursor y = 0
    };

    // confıgure display 
    displaySendCommand(&mySPI, &displayDC, &displayCE, cmd_buffer, 6);
    // draw hello world
    displaySendData(&mySPI, &displayDC, &displayCE, GAME_SCREEN, 504);


    while (true) {
    }
    return 0;
}


void displaySendCommand(SPI_Handle_t* spi, GPIO_Handle_t* dc, GPIO_Handle_t* ce, uint8_t* buffer, uint32_t len) {
    // Select command mode
    GPIO_WritePin_H(dc, false);
    // enable chip
    GPIO_WritePin_H(ce, false);

    // send command
    SPI_SendData_blocking(spi->pSPI, buffer, len);

    //disable chip
    GPIO_WritePin_H(ce, true);
    // Select data mode
    GPIO_WritePin_H(dc, true);
}

void displaySendData(SPI_Handle_t* spi, GPIO_Handle_t* dc, GPIO_Handle_t* ce, uint8_t* buffer, uint32_t len) {
    // Select data mode
    GPIO_WritePin_H(dc, true);
    // enable chip
    GPIO_WritePin_H(ce, false);

    // send command
    SPI_SendData_blocking(spi->pSPI, buffer, len);
    //disable chip
    GPIO_WritePin_H(dc, true);
}
